#!/usr/bin/env bash
set -euo pipefail

# totally-legal-bro: Keep your repo legally chill
# The main CLI entry point

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/lib"

# Version and global toggles
VERSION="0.1.1"
OUTPUT_JSON=0
QUIET=0
VERBOSE=0
CONFIG_FILE="${LEGALBRO_CONFIG:-.legalbro.json}"

# Source all library modules
source "${LIB_DIR}/config.sh"
source "${LIB_DIR}/check.sh"
source "${LIB_DIR}/fix.sh"
source "${LIB_DIR}/init.sh"
source "${LIB_DIR}/report.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

function show_usage() {
    cat <<EOF
ðŸ¤™ totally-legal-bro - Keep your repo legally chill

Usage: totally-legal-bro <command> [options]

Commands:
    init        Set up config, git hooks, and CI templates
    check       Validate LICENSE, headers, and dependency licenses
    fix         Auto-fix missing headers and repo files
    report      Generate a detailed compliance report

Global Options:
    --version       Print version and exit
    --config <path> Use an alternate .legalbro.json
    --json          JSON output (check/report)
    --verbose       Verbose output
    --quiet         Quiet output (minimal)

Options:
    -h, --help  Show this help message

Examples:
    totally-legal-bro init
    totally-legal-bro check
    totally-legal-bro fix
    totally-legal-bro report

For more info, check docs/SPEC.md
EOF
}

# Global option parsing
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --version)
            echo "${VERSION}"
            exit 0
            ;;
        --config)
            LEGALBRO_CONFIG="$2"
            CONFIG_FILE="$2"
            if [[ ! -r "${CONFIG_FILE}" ]]; then
                echo "Error: Config file not found or unreadable: ${CONFIG_FILE}" >&2
                exit 1
            fi
            shift 2
            ;;
        --json)
            OUTPUT_JSON=1
            shift
            ;;
        --verbose)
            VERBOSE=1
            shift
            ;;
        --quiet)
            QUIET=1
            shift
            ;;
        -h|--help|help)
            show_usage
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            ARGS+=("$1")
            shift
            break
            ;;
    esac
done

set -- "${ARGS[@]}" "$@"

# Main command router
COMMAND="${1:-}"

case "${COMMAND}" in
    init)
        cmd_init "${@:2}"
        ;;
    check)
        cmd_check "${@:2}"
        ;;
    fix)
        cmd_fix "${@:2}"
        ;;
    report)
        cmd_report "${@:2}"
        ;;
    -h|--help|help|"")
        show_usage
        exit 0
        ;;
    *)
        echo -e "${RED}Error: Unknown command '${COMMAND}'${NC}" >&2
        echo ""
        show_usage
        exit 1
        ;;
esac
# Main command router
# (after parsing global options we may override config path)

# Sync CONFIG_FILE with LEGALBRO_CONFIG if set after sourcing config.sh
if [[ -n "${LEGALBRO_CONFIG:-}" ]]; then
    CONFIG_FILE="${LEGALBRO_CONFIG}"
fi
